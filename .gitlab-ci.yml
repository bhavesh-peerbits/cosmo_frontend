stages:
  - sonar
  - build_code ğŸ”¨
  - build_docker ğŸ³
  - test âœ…
  - tag ğŸ”–
  - deploy ğŸš€

variables:
  BASE_IMAGE: aramis-nexus.aizoon.it:5000/cosmo/fe
  IMAGE_COSMO: $BASE_IMAGE/${CI_COMMIT_REF_SLUG}
  TAG_IMAGE: $BASE_IMAGE:${CI_COMMIT_TAG}

sonar:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: ['']
  variables:
    GIT_DEPTH: 0
  stage: sonar
  script:
    - sonar-scanner -Dsonar.projectKey=cosmo-fe -Dsonar.qualitygate.wait=true
  allow_failure: true
  only:
    - develop

image: node:lts-alpine
before_script:
  - yarn install

# Cache modules in between jobs
cache: &global_cache
  key: $CI_PROJECT_ID
  policy: pull
  paths:
    - node_modules
    - 'app/node_modules'
    - 'server/node_modules'

build:
  stage: build_code ğŸ”¨
  variables:
    http_proxy: http://srvprx01.aizoon.it:3128
    https_proxy: http://srvprx01.aizoon.it:3128
    no_proxy: localhost,127.0.0.1,*.aizoon.it
  script: yarn build
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull-push
  artifacts:
    expire_in: 1 day
    paths:
      - app/dist/
      - server/dist/

build_image:
  image: docker:19.03.8
  stage: build_docker ğŸ³
  script:
    - docker build --label "git-commit=${CI_COMMIT_SHORT_SHA}" -t $BASE_IMAGE/${CI_COMMIT_REF_SLUG} .
    - docker tag $BASE_IMAGE/${CI_COMMIT_REF_SLUG} $IMAGE_COSMO
    - docker push $BASE_IMAGE/${CI_COMMIT_REF_SLUG}
    - docker push $IMAGE_COSMO

trivy scan:
  image:
    name: aramis-nexus.aizoon.it:5000/esra/trivy:0.22.0
    entrypoint: ['']
  stage: test âœ…
  script:
    - trivy image $IMAGE_COSMO
  allow_failure: true

grype scan:
  image:
    name: aramis-nexus.aizoon.it:5000/esra/grype:v0.32.0
    entrypoint: ['']
  stage: test âœ…
  script:
    - grype $IMAGE_COSMO
  allow_failure: true

test:
  stage: test âœ…
  variables:
    NODE_ENV: 'CI'
  script:
    - yarn test
tag:
  image: aramis-nexus.aizoon.it:5000/esra/docker:20.10.8
  stage: tag ğŸ”–
  only:
    - tags
  script:
    - docker tag $IMAGE_COSMO $TAG_IMAGE && docker push $TAG_IMAGE
#deploy sviluppo:
#  image: aramis-nexus.aizoon.it:5000/ansible
#  stage: deploy ğŸš€
#  environment:
#    name: sviluppo
#    url: http://172.17.0.149:25555/
#  when: manual
#  script:
#    - cd operation/ansible
#    - chmod go-rwx .
#    - ansible-playbook --limit esra --vault-password-file $VAULT_PASS --extra-vars "{'image_name':'$IMAGE_ESRA'}" deploy_sviluppo.yml
